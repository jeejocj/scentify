<%- include("../../views/partials/user/header") %>

<style>
    .checkout__form {
        padding: 40px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .checkout__form h4 {
        color: #333;
        font-weight: 600;
        border-bottom: 1px solid #e1e1e1;
        padding-bottom: 20px;
        margin-bottom: 25px;
    }

    .checkout__form p {
        column-rule: #666;
        margin-bottom: 20px;
    }

    .checkout__order {
        background: #f5f5f5;
        padding: 30px;
        border-radius: 8px;
    }

    .checkout__order h4 {
        color: #333;
        font-weight: 600;
        border-bottom: 1px solid #e1e1e1;
        padding-bottom: 20px;
        margin-bottom: 20px;
    }

    .checkout__order .checkout__order__products {
        font-size: 16px;
        color: #333;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .checkout__order ul {
        margin-bottom: 25px;
    }

    .checkout__order ul li {
        font-size: 16px;
        color: #444;
        line-height: 40px;
        list-style: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .checkout__order .checkout__order__total {
        font-size: 18px;
        color: #333;
        font-weight: 600;
        border-bottom: 1px solid #e1e1e1;
        border-top: 1px solid #e1e1e1;
        padding: 15px 0;
        margin-bottom: 25px;
    }

    .address-card {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .address-card:hover {
        border-color: #666;
    }

    .address-card.selected {
        border-color: #333;
        background-color: #f8f9fa;
    }

    .address-card input[type="radio"] {
        margin-right: 10px;
    }

    .payment-method {
        margin-top: 30px;
    }

    .payment-method label {
        display: block;
        margin-bottom: 10px;
    }

    .product-item {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .product-image {
        width: 60px;
        height: 60px;
        margin-right: 15px;
    }

    .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 4px;
    }

    .product-details {
        flex-grow: 1;
    }

    .product-name {
        font-weight: 500;
        margin-bottom: 5px;
    }

    .product-price {
        color: #666;
    }

    .coupon-section {
        margin-bottom: 20px;
    }

    .coupon-section .input-group-append {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 0 4px 4px 0;
    }

    .coupon-section .input-group-append button {
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
    }

    .coupon-section .input-group-append button:hover {
        background-color: #f0f0f0;
    }

    .checkout__order__subtotal {
        font-size: 18px;
        color: #333;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .checkout__order__discount {
        font-size: 18px;
        color: #333;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .checkout__order__total {
        font-size: 22px;
        color: #333;
        font-weight: 600;
        margin-bottom: 20px;
    }

    .discount__content {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .discount__content h6 {
        color: #333;
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 15px;
    }

    .discount__content form {
        display: flex;
        gap: 10px;
    }

    .discount__content input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .discount__content .site-btn {
        padding: 8px 20px;
        background: #111111;
        border: none;
        color: #ffffff;
        font-size: 14px;
        font-weight: 500;
        border-radius: 4px;
        cursor: pointer;
    }

    .discount__content .site-btn:hover {
        background: #333333;
    }

    .coupon-message {
        margin-top: 10px;
        font-size: 14px;
    }

    .coupon-message.success {
        color: #28a745;
    }

    .coupon-message.error {
        color: #dc3545;
    }

    .active-coupon {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 10px;
        padding: 8px 12px;
        background: #e8f5e9;
        border-radius: 4px;
    }

    .active-coupon span {
        color: #2e7d32;
        font-size: 14px;
    }

    .active-coupon button {
        background: none;
        border: none;
        color: #d32f2f;
        font-size: 14px;
        cursor: pointer;
        padding: 4px 8px;
    }

    .active-coupon button:hover {
        text-decoration: underline;
    }

    .coupon-form {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .coupon-form input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .coupon-message {
        margin-top: 10px;
    }
    
    .active-coupon {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        margin-top: 10px;
    }
    
    .checkout__order__discount {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        color: #28a745;
    }

    .available-coupons {
        border-top: 1px solid #eee;
        padding-top: 15px;
    }
    
    .coupon-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .coupon-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .coupon-item:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    
    .coupon-info {
        flex: 1;
    }
    
    .coupon-info p {
        color: #28a745;
        font-weight: 500;
    }
    
    .coupon-info small {
        display: block;
        color: #6c757d;
    }
</style>

<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__text">
                    <h4>Check Out</h4>
                    <div class="breadcrumb__links">
                        <a href="/">Home</a>
                        <a href="/cart">Shopping Cart</a>
                        <span>Check Out</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Breadcrumb Section End -->

<!-- Checkout Section Begin -->
<section class="checkout spad">
    <div class="container">
        <div class="checkout__form">
            <div class="row">
                <div class="col-lg-8 col-md-6">
                    <h4>Shipping Details</h4>
                    <div class="shipping-addresses">
                        <% if (addressData && addressData.address && addressData.address.length > 0) { %>
                            <% addressData.address.forEach((addr, index) => { %>
                                <div class="address-card" onclick="selectAddress(this, '<%= addr._id %>')">
                                    <input type="radio" name="address" value="<%= addr._id %>" <%= index === 0 ? 'checked' : '' %>>
                                    <strong><%= addr.name %></strong><br>
                                    <%= addr.street %>, <%= addr.city %><br>
                                    <%= addr.state %> - <%= addr.pincode %><br>
                                    Phone: <%= addr.mobile %>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <p>No addresses found. Please add a shipping address.</p>
                        <% } %>
                        <a href="/addAddress" class="site-btn">Add New Address</a>
                    </div>

                    <div class="payment-method">
                        <h4>Payment Method</h4>
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="cashOnDelivery" checked>
                            Cash on Delivery (COD)
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="onlinePayment">
                            Online Payment
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="wallet">
                            Wallet
                        </label>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6">
                    <div class="checkout__order">
                        <h4>Your Order</h4>
                        <div class="checkout__order__products">Products <span>Total</span></div>
                        <ul>
                            <% products.forEach(item => { %>
                                <li>
                                    <%= item.productName %> (<%= item.quantity %>)
                                    <span>â‚¹<%= parseInt(item.totalPrice).toLocaleString('en-IN') %></span>
                                </li>
                            <% }); %>
                        </ul>

                        <div class="discount__content">
                            <h6>Discount codes</h6>
                            <div class="coupon-form">
                                <input type="text" id="couponCode" placeholder="Enter your coupon code">
                                <button type="button" onclick="applyCoupon()" class="btn btn-primary">Apply</button>
                            </div>
                            <div id="couponMessage" class="coupon-message mt-2"></div>
                            
                            <% if (activeCoupon) { %>
                                <div class="active-coupon mt-2">
                                    <span>Coupon "<%= activeCoupon.name %>" applied</span>
                                    <button onclick="removeCoupon()" class="btn btn-sm btn-danger">Remove</button>
                                </div>
                            <% } %>

                            <% if (availableCoupons && availableCoupons.length > 0) { %>
                                <div class="available-coupons mt-3">
                                    <h6>Available Coupons</h6>
                                    <div class="coupon-list">
                                        <% availableCoupons.forEach(coupon => { %>
                                            <div class="coupon-item" onclick="selectCoupon('<%= coupon.name %>')">
                                                <div class="coupon-info">
                                                    <strong><%= coupon.name %></strong>
                                                    <p class="mb-0">
                                                        <%= coupon.type === 'percentage' ? `${coupon.offerPrice}% off` : `â‚¹${coupon.offerPrice} off` %>
                                                    </p>
                                                    <small>Min. Purchase: â‚¹<%= coupon.minimumPrice %></small>
                                                    <small>Expires: <%= new Date(coupon.expireOn).toLocaleDateString() %></small>
                                                    <% if (coupon.description) { %>
                                                        <small class="text-muted"><%= coupon.description %></small>
                                                    <% } %>
                                                </div>
                                                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); applyCouponDirect('<%= coupon.name %>')">
                                                    Apply
                                                </button>
                                            </div>
                                        <% }); %>
                                    </div>
                                </div>
                            <% } %>
                        </div>

                        <div class="checkout__order__subtotal">
                            Subtotal <span id="subtotal">â‚¹<%= parseInt(subtotal).toLocaleString('en-IN') %></span>
                        </div>
                        
                        <div id="discountRow" class="checkout__order__discount" style="display: none;">
                            Discount <span id="discountAmount">â‚¹0</span>
                        </div>
                        
                        <div class="checkout__order__total">
                            Total <span id="finalAmount">â‚¹<%= parseInt(finalAmount).toLocaleString('en-IN') %></span>
                        </div>

                        <button type="button" class="site-btn" onclick="placeOrder()">PLACE ORDER</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Checkout Section End -->

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    // Debug logging
    console.log('Products:', <%- JSON.stringify(products) %>);

    async function applyCoupon() {
        const couponCode = document.getElementById('couponCode').value;
        if (!couponCode.trim()) {
            document.getElementById('couponMessage').innerHTML = 
                '<div class="alert alert-danger">Please enter a coupon code</div>';
            return;
        }

        const subtotalElement = document.getElementById('subtotal');
        const totalAmount = subtotalElement.textContent.replace(/[â‚¹,]/g, '').trim();
        
        try {
            const response = await fetch('/checkout/apply-coupon', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    couponCode: couponCode,
                    totalAmount: parseFloat(totalAmount)
                })
            });
            
            const data = await response.json();
            const messageDiv = document.getElementById('couponMessage');
            
            if (data.success) {
                messageDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
                
                // Remove any existing active coupon
                const existingCoupon = document.querySelector('.active-coupon');
                if (existingCoupon) {
                    existingCoupon.remove();
                }
                
                // Show discount row
                const discountRow = document.getElementById('discountRow');
                discountRow.style.display = 'flex';
                
                // Update discount amount
                const discountAmount = document.getElementById('discountAmount');
                discountAmount.textContent = `-â‚¹${parseFloat(data.discount).toLocaleString('en-IN')}`;
                
                // Update final amount
                const finalAmount = document.getElementById('finalAmount');
                finalAmount.textContent = `â‚¹${parseFloat(data.total).toLocaleString('en-IN')}`;
                
                // Show active coupon section
                const activeCouponHtml = `
                    <div class="active-coupon mt-2">
                        <span>Coupon "${couponCode}" applied</span>
                        <button onclick="removeCoupon()" class="btn btn-sm btn-danger">Remove</button>
                    </div>
                `;
                messageDiv.insertAdjacentHTML('afterend', activeCouponHtml);
            } else {
                messageDiv.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
            }
        } catch (error) {
            console.error('Error applying coupon:', error);
            document.getElementById('couponMessage').innerHTML = 
                '<div class="alert alert-danger">Error applying coupon. Please try again.</div>';
        }
    }

    async function removeCoupon() {
        try {
            const subtotalElement = document.getElementById('subtotal');
            const totalAmount = subtotalElement.textContent.replace(/[â‚¹,]/g, '').trim();
            
            const response = await fetch('/checkout/remove-coupon', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ totalAmount: parseFloat(totalAmount) })
            });
            
            const data = await response.json();
            if (data.success) {
                // Reset coupon code input
                document.getElementById('couponCode').value = '';
                
                // Hide discount row
                document.getElementById('discountRow').style.display = 'none';
                
                // Reset final amount to original subtotal
                document.getElementById('finalAmount').textContent = `â‚¹${parseFloat(totalAmount).toLocaleString('en-IN')}`;
                
                // Remove active coupon section
                const activeCoupon = document.querySelector('.active-coupon');
                if (activeCoupon) {
                    activeCoupon.remove();
                }
                
                // Clear any messages
                document.getElementById('couponMessage').innerHTML = '';
            } else {
                document.getElementById('couponMessage').innerHTML = 
                    '<div class="alert alert-danger">' + data.message + '</div>';
            }
        } catch (error) {
            console.error('Error removing coupon:', error);
            document.getElementById('couponMessage').innerHTML = 
                '<div class="alert alert-danger">Error removing coupon. Please try again.</div>';
        }
    }

    function selectCoupon(code) {
        document.getElementById('couponCode').value = code;
    }

    function applyCouponDirect(code) {
        document.getElementById('couponCode').value = code;
        applyCoupon();
    }

    // Add keypress event listener for coupon input
    document.getElementById('couponCode').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            applyCoupon();
        }
    });

    async function placeOrder() {
        const selectedAddress = document.querySelector('input[name="address"]:checked');
        if (!selectedAddress) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Please select a delivery address'
            });
            return;
        }

        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
        if (!paymentMethod) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Please select a payment method'
            });
            return;
        }

        const products = <%- JSON.stringify(products) %>;
        const subtotal = <%= parseInt(subtotal) %>;
        const total = <%= parseInt(finalAmount) %>;

        const orderData = {
            address: selectedAddress.value,
            products: JSON.stringify(products),
            subtotal: subtotal,
            total: total,
            paymentMethod: paymentMethod.value
        };

        try {
            if (paymentMethod.value === 'onlinePayment') {
                const response = await fetch('/checkout/place-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                
                const data = await response.json();
                if (data.success) {
                    const options = {
                        key: data.key_id,
                        amount: data.amount,
                        currency: data.currency,
                        name: data.name,
                        description: data.description,
                        order_id: data.order_id,
                        prefill: data.prefill,
                        handler: async function (response) {
                            try {
                                const verifyResponse = await fetch('/checkout/verify-payment', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        razorpay_order_id: response.razorpay_order_id,
                                        razorpay_payment_id: response.razorpay_payment_id,
                                        razorpay_signature: response.razorpay_signature,
                                        orderDetails: JSON.stringify(orderData)
                                    })
                                });
                                
                                const verifyData = await verifyResponse.json();
                                if (verifyData.success) {
                                    window.location.href = `/checkout/confirmation?orderId=${verifyData.orderId}`;
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Payment Failed',
                                        text: verifyData.message || 'Payment verification failed'
                                    });
                                }
                            } catch (error) {
                                console.error('Error verifying payment:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'Error verifying payment. Please contact support.'
                                });
                            }
                        }
                    };
                    
                    const rzp = new Razorpay(options);
                    rzp.open();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'Error creating order'
                    });
                }
            } else if (paymentMethod.value === 'cashOnDelivery') {
                const response = await fetch('/checkout/place-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                
                const data = await response.json();
                if (data.success) {
                    window.location.href = `/checkout/confirmation?orderId=${data.orderId}`;
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'Error creating order'
                    });
                }
            }
        } catch (error) {
            console.error('Error placing order:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error placing order. Please try again.'
            });
        }
    }
</script>

<%- include("../../views/partials/user/footer") %>