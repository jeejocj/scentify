<%- include("../../views/partials/user/header") %>
<style>
 .card-green {
   background-color: #ADD8E6;
 }
 .main {
   padding: 30px 0;
 }


 .dashboard-menu {
   background-color: #cce3e6;
   border-radius: 10px;
   padding: 15px;
   box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
 }


 .dashboard-menu .nav-link {
 font-weight: bold;
 color: #30683c;
 box-shadow: 0 4px 10px rgba(123, 131, 112, 0.3), 0 4px 20px rgba(0, 191, 255, 0.2);
 transition: box-shadow 0.3s ease;
}


.dashboard-menu .nav-link:hover {
 color: #00bfff;
 box-shadow: 0 4px 15px rgba(173, 255, 47, 0.5), 0 6px 25px rgba(0, 191, 255, 0.4);
}


 .card {
   border-radius: 10px;
   box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
   margin-bottom: 20px;
 }


 .card-header {
   background-color: #487379;
   color: white;
   border-radius: 10px 10px 0 0;
 }


 .btn-success {
   background-color: #577194;
   border-color: #6bb87d;
 }


 .btn-success:hover {
   background-color: #506955;
 }


 .form-group {
   margin-bottom: 15px;
 }


 .required {
   color: red;
 }


  @media (max-width: 768px) {
   .dashboard-menu {
     padding: 10px;
   }


   .card {
     margin-bottom: 15px;
   }
 }
 .page-header.breadcrumb-wrap {
 background-color: #eee2e9;
 padding: 15px 0;
}


.breadcrumb {
 display: flex;
 align-items: center;
 font-family: 'Arial', sans-serif;
 font-size: 16px;
 color: #121311;
}


.breadcrumb a {
 color: #007bff;
 text-decoration: none;
 position: relative;
 margin: 0 5px;
}


.breadcrumb a:hover {
 color: #0056b3;



.breadcrumb span {
 margin: 0 5px;
 color: #999;



.breadcrumb a::after {
 content: '';
 position: absolute;
 width: 100%;
 height: 2px;
 background: #6e6e3a;
 left: 0;
 bottom: -2px;
 transform: scaleX(0);
 transition: transform 0.3s ease;



.breadcrumb a:hover::after {
 transform: scaleX(1);
}
</style>

<section class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__text">
                    <h4>Account</h4>
                    <div class="breadcrumb__links">
                        <a href="/">Home</a>
                        <a href="/userProfile">Profile</a>
                        <span>Account</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<main class="main">
  <section class="pt-10 pb-10">
   <div class="container">
     <div class="row">
       <div class="col-lg-10 m-auto">
         <div class="row">
           <div class="col-md-4">
             <div class="dashboard-menu">
               <ul class="nav flex-column" role="tablist">
                 <li class="nav-item">
                   <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false">
                     <i class="fi-rs-settings-sliders mr-10"></i>Dashboard
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="true">
                     <i class="fi-rs-marker mr-10"></i>My Address
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false">
                     <i class="fi-rs-shopping-bag mr-10"></i>Orders
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#track-orders" role="tab" aria-controls="track-orders" aria-selected="false">
                     <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet Status
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#referal" role="tab" aria-controls="track-orders" aria-selected="false">
                     <i class="fi-rs-shopping-cart-check mr-10"></i>Referals
                   </a>
                 </li>
                 <li class="nav-item">
                   <a class="nav-link" href="/logout">
                     <i class="fi-rs-sign-out mr-10"></i>Logout
                   </a>
                 </li>
               </ul>
             </div>
           </div>
           <div class="col-md-8">
             <div class="tab-content dashboard-content">


               <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                 <div class="card card-green">
                   <div class="card-header">
                     <h5 class="mb-0 text-center">User Profile</h5>
                   </div>
                   <div class="card-body text-center">
                     <h5 class="card-title"><%=user.name%></h5>
                     <p class="card-text">
                       <strong>Phone:</strong><%=user.phone%>
                     </p>
                     <p class="card-text">
                       <strong>Email:</strong><%=user.email%>
                     </p>
                     <a href="/change-email" class="btn btn-sm btn-success ml-2">Change Email</a>
                     <a href="/change-password" class="btn btn-sm btn-success">Change Password</a>
                   </div>
                 </div>
               </div>


               <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                 <div class="card">
                   <div class="card-header">
                     <h5 class="mb-0">My Addresses</h5>
                   </div>
                   <div class="card-body">
                     <% if (addressData && addressData.address && addressData.address.length > 0) { %>
                       <div class="row">
                         <% addressData.address.forEach(addr => { %>
                           <div class="col-lg-6 mb-3">
                             <div class="card">
                               <div class="card-body">
                                 <h6 class="card-title"><%= addr.name %></h6>
                                 <p class="card-text">
                                   <%= addr.landMark %><br>
                                   <%= addr.city %>, <%= addr.state %><br>
                                   <%= addr.pincode %><br>
                                   Phone: <%= addr.phone %>
                                 </p>
                                 <div class="d-flex justify-content-between">
                                   <button onclick="editAddress('<%= addr._id %>')" class="btn btn-sm btn-primary">Edit</button>
                                   <button onclick="deleteAddress('<%= addr._id %>')" class="btn btn-sm btn-danger">Delete</button>
                                 </div>
                               </div>
                             </div>
                           </div>
                         <% }); %>
                       </div>
                     <% } else { %>
                       <p>No addresses found.</p>
                     <% } %>
                     <div class="mt-3">
                       <a href="/addAddress" class="btn btn-success">Add New Address</a>
                     </div>
                   </div>
                 </div>
               </div>


               <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                 <div class="card">
                   <div class="card-header">
                     <h5 class="mb-0">Your Orders</h5>
                   </div>
                   <div class="card-body">
                     <div class="table-responsive">
                       <table class="table">
                         <thead>
                           <tr>
                             <th>Order</th>
                             <th>Date</th>
                             <th>Status</th>
                             <th>Total</th>
                             <th>Actions</th>
                           </tr>
                         </thead>
                         <tbody>
                           <% if (orders && orders.length > 0) { %>
                             <% orders.forEach(order => { %>
                               <tr>
                                 <td>#<%= order.orderId %></td>
                                 <td><%= new Date(order.createdOn).toLocaleDateString() %></td>
                                 <td><%= order.status %></td>
                                 <td>â‚¹<%= order.finalAmount %></td>
                                 <td>
                                   <button type="button" 
                                     class="btn btn-sm btn-info view-order-btn" 
                                     data-order-id="<%= order._id %>">
                                     View
                                   </button>
                                   
                                   <% if(order.status === 'Pending')  { %>
                                     <button 
                                       type="button" 
                                       class="btn btn-sm btn-danger cancel-order-btn" 
                                       data-order-id="<%= order._id %>">
                                       Cancel
                                     </button>
                                   <% } %>
                                 </td>
                               </tr>
                             <% }); %>
                           <% } else { %>
                             <tr>
                               <td colspan="5">No orders found</td>
                             </tr>
                           <% } %>
                         </tbody>
                       </table>
                     </div>
                   </div>
                 </div>
               </div>


               <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="track-orders-tab">
                 <div class="card">
                   <div class="card-header">
                     <h5 class="mb-0">Wallet</h5>
                   </div>
                   <div class="card-body contact-from-area">
                     <div class="row">
                       <div class="col-lg-8 mx-auto text-center mt-90">
                         <div class="mb-3">
                             <label for="walletAmount" class="h4">Amount</label>
                             <div class="h3" id="walletBalance">â‚¹<%= user.wallet?.balance || 0 %></div>
                           </div>
                           <button type="button" class="btn btn-success" onclick="addMoneyToWallet()">Add Money</button>
                           <div class="mt-4">
                             <h5>Transaction History</h5>
                             <div class="table-responsive">
                               <table class="table">
                                 <thead>
                                   <tr>
                                     <th>Date</th>
                                     <th>Description</th>
                                     <th>Amount</th>
                                     <th>Type</th>
                                   </tr>
                                 </thead>
                                 <tbody>
                                   <% if (user.wallet?.transactions && user.wallet.transactions.length > 0) { %>
                                     <% user.wallet.transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(transaction => { %>
                                       <tr>
                                         <td><%= new Date(transaction.date).toLocaleString('en-IN', { 
                                           year: 'numeric', 
                                           month: 'short', 
                                           day: 'numeric',
                                           hour: '2-digit',
                                           minute: '2-digit'
                                         }) %></td>
                                         <td><%= transaction.description %></td>
                                         <td class="<%= transaction.type === 'credit' ? 'text-success' : 'text-danger' %>">
                                           <%= transaction.type === 'credit' ? '+' : '-' %>â‚¹<%= transaction.amount %>
                                         </td>
                                         <td>
                                           <span class="badge <%= transaction.type === 'credit' ? 'bg-success' : 'bg-danger' %>">
                                             <%= transaction.type %>
                                           </span>
                                         </td>
                                       </tr>
                                     <% }); %>
                                   <% } else { %>
                                     <tr>
                                       <td colspan="4" class="text-center">No transactions found</td>
                                     </tr>
                                   <% } %>
                                 </tbody>
                               </table>
                             </div>
                           </div>
                       </div>
                     </div>
                   </div>
                 </div>
               </div>


               <div class="tab-pane fade" id="referal" role="tabpanel" aria-labelledby="track-orders-tab">
                 <div class="card">
                   <div class="card-header">
                     <h5 class="mb-0">Referal</h5>
                   </div>
                   <div class="card-body">
                     <h6 class="mb-3">Refer your friends and earn money!</h6>
                     <p>Share this link: <strong>></strong></p>
                     <p>Earned: â‚¹</p>
                   </div>
                 </div>
       </div>
     </div>
   </div>
 </section>
</main>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <h6>Order Information</h6>
            <p><strong>Order ID:</strong> <span id="modalOrderId"></span></p>
            <p><strong>Date:</strong> <span id="modalOrderDate"></span></p>
            <p><strong>Status:</strong> <span id="modalOrderStatus"></span></p>
            <p><strong>Total Amount:</strong> â‚¹<span id="modalOrderTotal"></span></p>
            <p id="modalOrderDiscount" style="display: none;">
              <strong>Discount Applied:</strong> â‚¹<span id="modalDiscountAmount"></span>
            </p>
          </div>
          <div class="col-md-6">
            <h6>Shipping Address</h6>
            <div id="modalShippingAddress"></div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="modalOrderItems">
            </tbody>
            <tfoot>
              <tr>
                <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
                <td>â‚¹<span id="modalSubtotal"></span></td>
              </tr>
              <tr id="modalDiscountRow" style="display: none;">
                <td colspan="3" class="text-end"><strong>Discount:</strong></td>
                <td class="text-success">-â‚¹<span id="modalDiscountTotal"></span></td>
              </tr>
              <tr>
                <td colspan="3" class="text-end"><strong>Total:</strong></td>
                <td><strong>â‚¹<span id="modalFinalTotal"></span></strong></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    // Address Functions
    function editAddress(addressId) {
        Swal.fire({
            title: 'Edit Address',
            text: 'Do you want to edit this address?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, edit it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = `/editAddress?id=${addressId}`;
            }
        });
    }

    function deleteAddress(addressId) {
        Swal.fire({
            title: 'Delete Address?',
            text: 'This action cannot be undone!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'No, keep it'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = `/deleteAddress?id=${addressId}`;
            }
        });
    }

    async function addMoneyToWallet() {
        try {
            const { value: amount } = await Swal.fire({
                title: 'Enter amount to add',
                input: 'number',
                inputLabel: 'Amount (â‚¹)',
                inputPlaceholder: 'Enter amount',
                inputAttributes: {
                    min: '1',
                    step: '1'
                },
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value || value < 1) {
                        return 'Please enter a valid amount greater than 0'
                    }
                }
            });

            if (amount) {
                // Create Razorpay order
                const response = await fetch('/wallet/recharge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ amount: amount })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Error creating order');
                }

                // Configure Razorpay options
                const options = {
                    key: data.key_id,
                    amount: data.order.amount,
                    currency: data.order.currency,
                    name: 'Scentify',
                    description: 'Wallet Recharge',
                    order_id: data.order.id,
                    handler: async function (response) {
                        try {
                            // Verify payment
                            const verifyResponse = await fetch('/wallet/verify', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_order_id: response.razorpay_order_id,
                                    razorpay_signature: response.razorpay_signature,
                                    amount: amount
                                })
                            });

                            const verifyData = await verifyResponse.json();

                            if (verifyData.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: 'Money added to wallet successfully!',
                                    showConfirmButton: false,
                                    timer: 1500
                                }).then(() => {
                                    // Update wallet balance display
                                    const walletBalanceElement = document.getElementById('walletBalance');
                                    if (walletBalanceElement) {
                                        walletBalanceElement.textContent = `â‚¹${verifyData.newBalance}`;
                                    }
                                });
                            } else {
                                throw new Error(verifyData.message || 'Payment verification failed');
                            }
                        } catch (error) {
                            console.error('Payment verification error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error!',
                                text: error.message || 'Error verifying payment'
                            });
                        }
                    },
                    prefill: {
                        name: '<%= user.name %>',
                        email: '<%= user.email %>',
                    },
                    theme: {
                        color: '#3399cc'
                    }
                };

                // Create Razorpay instance and open payment modal
                const rzp = new Razorpay(options);
                rzp.open();
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error!',
                text: error.message || 'Something went wrong'
            });
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // View Order Button Click Handler
        const viewButtons = document.querySelectorAll('.view-order-btn');
        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                fetchOrderDetails(orderId);
            });
        });

        // Function to fetch order details
        function fetchOrderDetails(orderId) {
            fetch(`/orders/get-details/${orderId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        populateModal(data.order);
                        new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
                    } else {
                        Swal.fire('Error', data.message || 'Failed to fetch order details', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error', 'Something went wrong', 'error');
                });
        }

        // Function to populate modal with order details
        function populateModal(order) {
            // Order Information
            document.getElementById('modalOrderId').textContent = order.orderId;
            document.getElementById('modalOrderDate').textContent = new Date(order.createdOn).toLocaleDateString();
            document.getElementById('modalOrderStatus').textContent = order.status;
            document.getElementById('modalOrderTotal').textContent = order.finalAmount.toLocaleString();

            // Discount Information
            if (order.discount > 0) {
                document.getElementById('modalOrderDiscount').style.display = 'block';
                document.getElementById('modalDiscountAmount').textContent = order.discount.toLocaleString();
                document.getElementById('modalDiscountRow').style.display = 'table-row';
                document.getElementById('modalDiscountTotal').textContent = order.discount.toLocaleString();
            } else {
                document.getElementById('modalOrderDiscount').style.display = 'none';
                document.getElementById('modalDiscountRow').style.display = 'none';
            }

            // Shipping Address
            const addressHtml = order.address ? `
                <p><strong>${order.address.name}</strong></p>
                <p>${order.address.landMark}</p>
                <p>${order.address.city}, ${order.address.state} ${order.address.pincode}</p>
                <p><strong>Phone:</strong> ${order.address.phone}</p>
            ` : '<p>No address information available</p>';
            document.getElementById('modalShippingAddress').innerHTML = addressHtml;

            // Order Items
            const itemsHtml = order.orderedItems.map(item => `
                <tr>
                    <td>
                        <div class="product-cell">
                            <div class="product-image">
                                <img src="/uploads/re-image/${item.product.productImage[0]}" 
                                     alt="${item.product.productName}" 
                                     class="img-fluid" 
                                     style="max-width: 60px;">
                            </div>
                            <div class="product-info">
                                <h6 class="product-name">${item.product.productName}</h6>
                            </div>
                        </div>
                    </td>
                    <td>${item.quantity}</td>
                    <td>â‚¹${item.price.toLocaleString()}</td>
                    <td>â‚¹${(item.quantity * item.price).toLocaleString()}</td>
                </tr>
            `).join('');
            document.getElementById('modalOrderItems').innerHTML = itemsHtml;

            // Totals
            document.getElementById('modalSubtotal').textContent = order.totalPrice.toLocaleString();
            document.getElementById('modalFinalTotal').textContent = order.finalAmount.toLocaleString();
        }

        // Add event listener for cancel buttons
        const cancelButtons = document.querySelectorAll('.cancel-order-btn');
        cancelButtons.forEach(button => {
            button.addEventListener('click', function() {
                const orderId = this.getAttribute('data-order-id');
                cancelOrder(orderId);
            });
        });
    });

    function cancelOrder(orderId) {
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, cancel it!'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/orders/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ orderId: orderId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let message = data.message;
                        if (data.refundAmount) {
                            message += `. â‚¹${data.refundAmount} has been refunded to your wallet. New wallet balance: â‚¹${data.newWalletBalance}`;
                            // Update wallet balance display if it exists
                            const walletBalanceElement = document.getElementById('walletBalance');
                            if (walletBalanceElement) {
                                walletBalanceElement.textContent = `â‚¹${data.newWalletBalance}`;
                            }
                        }
                        Swal.fire({
                            title: 'Cancelled!',
                            text: message,
                            icon: 'success',
                            showConfirmButton: false,
                            timer: 2500
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire(
                            'Error!',
                            data.message,
                            'error'
                        );
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire(
                        'Error!',
                        'Failed to cancel order',
                        'error'
                    );
                });
            }
        });
    }
</script>

<style>
.modal-lg {
    max-width: 900px;
}

.product-cell {
    display: flex;
    align-items: center;
    gap: 15px;
}

.product-image {
    width: 60px;
    height: 60px;
    border-radius: 4px;
    overflow: hidden;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.product-name {
    margin: 0;
    font-size: 14px;
    color: #333;
}

.modal-body h6 {
    color: #333;
    font-weight: 600;
    margin-bottom: 15px;
}

.modal-body p {
    margin-bottom: 8px;
    color: #666;
}

.modal-body strong {
    color: #333;
}

.table th {
    background: #f8f9fa;
}
</style>

<%- include("../../views/partials/user/footer") %>
